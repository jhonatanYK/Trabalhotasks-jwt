<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Editar Serviço - Gestor de Serviços</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-900 text-white">
    <div class="min-h-screen flex flex-col justify-center items-center px-4 py-8">
      <div class="flex flex-col items-center mb-8">
        <img src="/trator.png" alt="Ícone" class="w-16 h-16 mb-3">
        <h2 class="text-2xl font-bold text-teal-400">Editar Serviço</h2>
      </div>

      <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md border border-teal-600">
        <form action="/tasks/edit/<%= task.id %>" method="POST" class="flex flex-col gap-4">
          
          <label for="client_id" class="font-semibold text-teal-300">Selecione um Cliente*</label>
          <select
            name="client_id"
            required
            class="bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500"
          >
            <% clients.forEach(function(client) { %>
              <option value="<%= client.id %>" <%= task.client_id == client.id ? 'selected' : '' %>>
                <%= client.name %>
              </option>
            <% }) %>
          </select>

          <label for="serviceName" class="font-semibold text-teal-300">Nome do Serviço*</label>
          <input
            type="text"
            name="serviceName"
            value="<%= task.serviceName %>"
            placeholder="Nome do Serviço*"
            required
            class="bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 placeholder-gray-500"
          />

          <label for="machine_id" class="font-semibold text-teal-300">Máquina*</label>
          <select
            name="machine_id"
            id="machine_id"
            required
            class="bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500"
          >
            <% machines.forEach(function(machine) { %>
              <option value="<%= machine.id %>" 
                      data-rate="<%= machine.hourlyRate %>"
                      <%= task.machine_id == machine.id ? 'selected' : '' %>>
                <%= machine.name %> - <%= machine.type %> (R$ <%= parseFloat(machine.hourlyRate).toFixed(2).replace('.', ',') %>/h)
              </option>
            <% }) %>
          </select>

          <input type="hidden" name="hourlyRate" id="hourlyRate" value="<%= task.machine ? task.machine.hourlyRate : 0 %>">

          <!-- Horímetros -->
          <div class="bg-gray-700 rounded-md p-4 border border-teal-600">
            <div class="flex flex-col gap-3">
              <div>
                <label for="startTime" class="font-semibold text-teal-300">Horímetro Inicial</label>
                <input
                  type="number"
                  step="0.1"
                  name="startTime"
                  id="startTime"
                  value="<%= task.startTime || '' %>"
                  placeholder="Ex: 1234.5"
                  class="bg-gray-600 text-white border border-gray-500 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 w-full"
                  readonly
                />
              </div>
              
              <div>
                <label for="endTime" class="font-semibold text-teal-300">Horímetro Final <%= task.endTime ? '(Finalizado)' : '(Finalizar Serviço)' %>*</label>
                <input
                  type="number"
                  step="0.1"
                  name="endTime"
                  id="endTime"
                  value="<%= task.endTime || '' %>"
                  placeholder="Ex: 1242.5"
                  <%= task.endTime ? 'readonly' : 'required' %>
                  class="bg-gray-<%= task.endTime ? '600' : '700' %> text-white border border-gray-<%= task.endTime ? '500' : '600' %> rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 w-full"
                />
                <% if (!task.endTime) { %>
                  <p class="text-xs text-yellow-400 mt-1">⚠️ Insira o horímetro final para concluir o serviço</p>
                <% } %>
              </div>
            </div>

            <!-- Resumo calculado -->
            <% if (task.hoursWorked && task.totalAmount) { %>
              <div class="mt-4 pt-4 border-t border-gray-600">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-gray-300">Total de Horas:</span>
                  <span class="text-teal-400 font-bold"><%= parseFloat(task.hoursWorked).toFixed(1).replace('.', ',') %> horas</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-300">Valor Total:</span>
                  <span class="text-green-400 font-bold text-lg">R$ <%= parseFloat(task.totalAmount).toFixed(2).replace('.', ',') %></span>
                </div>
              </div>
            <% } else { %>
              <div id="calculationPreview" class="mt-4 pt-4 border-t border-gray-600" style="display: none;">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-gray-300">Total de Horas:</span>
                  <span id="totalHours" class="text-teal-400 font-bold">0,0 horas</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-300">Valor Total:</span>
                  <span id="totalValue" class="text-green-400 font-bold text-lg">R$ 0,00</span>
                </div>
              </div>
            <% } %>
          </div>

          <input type="hidden" name="hoursWorked" id="hoursWorked" value="<%= task.hoursWorked || 0 %>">
          <input type="hidden" name="totalAmount" id="totalAmount" value="<%= task.totalAmount || 0 %>">

          <label for="location" class="font-semibold text-teal-300">Endereço / Localidade</label>
          <input
            type="text"
            name="location"
            value="<%= task.location || '' %>"
            placeholder="Endereço / Localidade"
            class="bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 placeholder-gray-500"
          />

          <button
            type="submit"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg transition duration-200 border-2 border-teal-400 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl mt-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Salvar Serviço
          </button>
        </form>

        <!-- Botões de Navegação -->
        <div class="mt-6 flex flex-col gap-3">
          <a
            href="/tasks"
            class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 border-2 border-gray-600 inline-flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Voltar para Serviços
          </a>
          <a
            href="/dashboard"
            class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 border-2 border-gray-600 inline-flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            Voltar ao Painel
          </a>
        </div>
      </div>
    </div>

    <script>
      // Atualiza o preço/hora quando seleciona uma máquina
      document.getElementById('machine_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const hourlyRate = selectedOption.getAttribute('data-rate');
        document.getElementById('hourlyRate').value = hourlyRate || 0;
        calculateHoursAndValue();
      });

      // Função para calcular horas e valor quando preencher horímetro final
      function calculateHoursAndValue() {
        const startHourmeter = parseFloat(document.getElementById('startTime').value) || 0;
        const endHourmeter = parseFloat(document.getElementById('endTime').value) || 0;
        const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;

        if (endHourmeter > startHourmeter && hourlyRate > 0) {
          const totalHours = endHourmeter - startHourmeter;
          const totalValue = totalHours * hourlyRate;

          // Mostra o preview
          document.getElementById('calculationPreview').style.display = 'block';
          document.getElementById('totalHours').textContent = totalHours.toFixed(1).replace('.', ',') + ' horas';
          document.getElementById('totalValue').textContent = 'R$ ' + totalValue.toFixed(2).replace('.', ',');

          // Atualiza campos hidden
          document.getElementById('hoursWorked').value = totalHours.toFixed(2);
          document.getElementById('totalAmount').value = totalValue.toFixed(2);
        } else {
          document.getElementById('calculationPreview').style.display = 'none';
          document.getElementById('hoursWorked').value = '0';
          document.getElementById('totalAmount').value = '0';
        }
      }

      // Adiciona listener se o campo endTime não estiver readonly
      const endTimeInput = document.getElementById('endTime');
      if (!endTimeInput.hasAttribute('readonly')) {
        endTimeInput.addEventListener('input', calculateHoursAndValue);
      }

      // Verifica se o usuário ainda está autenticado
      (function() {
        // Desabilita o botão voltar após logout - verifica se página veio do cache
        window.addEventListener('pageshow', function(event) {
          if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
            // Página foi restaurada do cache - verifica autenticação
            fetch('/api/check-auth', {
              method: 'GET',
              credentials: 'include'
            })
            .then(response => {
              if (!response.ok) {
                window.location.replace('/login');
              }
            })
            .catch(() => {
              window.location.replace('/login');
            });
          }
        });
      })();
    </script>
  </body>
</html>
