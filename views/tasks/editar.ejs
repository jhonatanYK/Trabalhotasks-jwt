<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Editar Servi√ßo - Gestor de Servi√ßos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-900 text-white">
    <div class="min-h-screen flex flex-col justify-center items-center px-4 py-8">
      <div class="flex flex-col items-center mb-8">
        <img src="/trator.png" alt="√çcone" class="w-16 h-16 mb-3">
        <h2 class="text-2xl font-bold text-teal-400">Editar Servi√ßo</h2>
      </div>

      <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-2xl border border-teal-600">
        <form action="/tasks/edit/<%= task.id %>" method="POST" class="flex flex-col gap-4">
          
          <% 
            // Verifica se tem m√°quinas associadas
            const hasMachines = task.machines && task.machines.length > 0;
            const allFinished = hasMachines && task.machines.every(m => m.task_machine && m.task_machine.endTime);
          %>
          
          <% if (hasMachines && !allFinished) { %>
            <!-- Modo Finalizar M√∫ltiplas M√°quinas -->
            
            <!-- Informa√ß√µes do Servi√ßo (readonly) -->
            <div class="bg-gray-700 rounded-md p-4 border border-teal-500">
              <h3 class="font-bold text-teal-300 mb-3">Informa√ß√µes do Servi√ßo</h3>
              
              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-400">Cliente:</span>
                  <span class="text-white font-semibold"><%= task.client ? task.client.name : '-' %></span>
                </div>
                <div class="flex flex-col">
                  <span class="text-gray-400 mb-1">Servi√ßo:</span>
                  <div class="text-white font-semibold bg-gray-600 rounded p-2 whitespace-pre-wrap"><%= task.serviceName %></div>
                </div>
                <% if (task.location) { %>
                <div class="flex justify-between">
                  <span class="text-gray-400">Local:</span>
                  <span class="text-white"><%= task.location %></span>
                </div>
                <% } %>
              </div>
            </div>

            <!-- M√°quinas do Servi√ßo -->
            <div class="space-y-4">
              <h3 class="font-bold text-teal-300">Finalizar M√°quinas</h3>
              
              <% task.machines.forEach(function(machine, index) { 
                const tm = machine.task_machine;
                const isFinished = tm && tm.endTime;
              %>
                <div class="bg-gray-700 rounded-lg p-4 border <%= isFinished ? 'border-green-500' : 'border-yellow-500' %>">
                  <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-white">
                      <%= machine.name %> - <%= machine.type %>
                    </h4>
                    <% if (isFinished) { %>
                      <span class="text-green-400 text-sm">‚úì Finalizada</span>
                    <% } else { %>
                      <span class="text-yellow-400 text-sm">‚è≥ Em andamento</span>
                    <% } %>
                  </div>

                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span class="text-gray-400">Valor/Hora:</span>
                      <span class="text-teal-300">R$ <%= parseFloat(tm.hourlyRate).toFixed(2).replace('.', ',') %></span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-400">Hor√≠metro Inicial:</span>
                      <span class="text-teal-400 font-bold"><%= tm.startTime %></span>
                    </div>
                    
                    <% if (!isFinished) { %>
                      <!-- Campo para finalizar -->
                      <div class="mt-3 pt-3 border-t border-gray-600">
                        <label class="block text-yellow-300 font-semibold mb-2">
                          üèÅ Hor√≠metro Final*
                        </label>
                        <input type="hidden" name="task_machine_ids[]" value="<%= tm.id %>">
                        <input 
                          type="number" 
                          step="0.1" 
                          name="end_times[]" 
                          placeholder="Ex: <%= (parseFloat(tm.startTime) + 10).toFixed(1) %>"
                          required
                          class="w-full bg-gray-800 text-white border border-yellow-500 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        />
                      </div>
                    <% } else { %>
                      <!-- Mostra os resultados finalizados -->
                      <div class="mt-3 pt-3 border-t border-gray-600">
                        <div class="flex justify-between">
                          <span class="text-gray-400">Hor√≠metro Final:</span>
                          <span class="text-teal-400 font-bold"><%= tm.endTime %></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-gray-400">Horas Trabalhadas:</span>
                          <span class="text-teal-400"><%= parseFloat(tm.hoursWorked).toFixed(1).replace('.', ',') %>h</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-gray-400">Valor Total:</span>
                          <span class="text-green-400 font-bold">R$ <%= parseFloat(tm.totalAmount).toFixed(2).replace('.', ',') %></span>
                        </div>
                      </div>
                    <% } %>
                  </div>
                </div>
              <% }); %>
            </div>

            <input type="hidden" name="client_id" value="<%= task.client_id %>">
            <input type="hidden" name="serviceName" value="<%= task.serviceName %>">
            <input type="hidden" name="location" value="<%= task.location || '' %>">

            <button
              type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition duration-200 border-2 border-green-400 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl mt-2"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Salvar Finaliza√ß√µes
            </button>

          <% } else { %>
            <!-- Modo Editar: Apenas permite editar campos b√°sicos -->
          
          <label for="client_id" class="font-semibold text-teal-300">Selecione um Cliente*</label>
          <select
            name="client_id"
            required
            class="bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500"
          >
            <% clients.forEach(function(client) { %>
              <option value="<%= client.id %>" <%= task.client_id == client.id ? 'selected' : '' %>>
                <%= client.name %>
              </option>
            <% }) %>
          </select>

          <label for="serviceName" class="font-semibold text-teal-300">Nome do Servi√ßo*</label>
          <textarea
            name="serviceName"
            placeholder="Descreva o servi√ßo realizado..."
            required
            rows="3"
            class="bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 placeholder-gray-500 resize-y"
          ><%= task.serviceName %></textarea>

          <label for="location" class="font-semibold text-teal-300">Endere√ßo / Localidade</label>
          <input
            type="text"
            name="location"
            value="<%= task.location || '' %>"
            placeholder="Endere√ßo / Localidade"
            class="bg-gray-700 text-white border border-gray-600 rounded-md px-3 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500 placeholder-gray-500"
          />

          <button
            type="submit"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg transition duration-200 border-2 border-teal-400 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl mt-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Salvar Altera√ß√µes
          </button>
          
          <% } %>
        </form>

        <!-- Bot√µes de Navega√ß√£o -->
        <div class="mt-6 flex flex-col gap-3">
          <a
            href="/tasks"
            class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 border-2 border-gray-600 inline-flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Voltar para Servi√ßos
          </a>
          <a
            href="/dashboard"
            class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 border-2 border-gray-600 inline-flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            Voltar ao Painel
          </a>
        </div>
      </div>
    </div>

    <script>
      // Verifica se o usu√°rio ainda est√° autenticado
      (function() {
        // Desabilita o bot√£o voltar ap√≥s logout - verifica se p√°gina veio do cache
        window.addEventListener('pageshow', function(event) {
          if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
            // P√°gina foi restaurada do cache - verifica autentica√ß√£o
            fetch('/api/check-auth', {
              method: 'GET',
              credentials: 'include'
            })
            .then(response => {
              if (!response.ok) {
                window.location.replace('/login');
              }
            })
            .catch(() => {
              window.location.replace('/login');
            });
          }
        });
      })();
    </script>
  </body>
</html>
