<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Máquinas - Gestor de Serviços</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-900 text-white">
    <%- include('../partials/notifications') %>
    
    <div class="max-w-6xl mx-auto mt-10 p-8 bg-gray-800 rounded-lg shadow-lg border border-teal-600">
      <!-- Cabeçalho com ícone -->
      <div class="flex items-center justify-center mb-6">
        <svg class="w-12 h-12 text-teal-400 mr-3" fill="currentColor" viewBox="0 0 640 512">
          <path d="M96 64c0-35.3 28.7-64 64-64H266.3c26.2 0 49.7 15.9 59.4 40.2L373.7 160H480V126.2c0-24.8 5.8-49.3 16.9-71.6l2.5-5c7.9-15.8 27.1-22.2 42.9-14.3s22.2 27.1 14.3 42.9l-2.5 5c-6.7 13.3-10.1 28-10.1 42.9V160h56c22.1 0 40 17.9 40 40v45.4c0 16.5-8.5 31.9-22.6 40.7l-43.3 27.1c-14.2-5.9-29.8-9.2-46.1-9.2c-39.3 0-74.1 18.9-96 48H352c0 17.7-14.3 32-32 32h-8.2c-1.7 4.8-3.7 9.5-5.8 14.1l5.8 5.8c12.5 12.5 12.5 32.8 0 45.3l-22.6 22.6c-12.5 12.5-32.8 12.5-45.3 0l-5.8-5.8c-4.6 2.2-9.3 4.1-14.1 5.8V480c0 17.7-14.3 32-32 32H160c-17.7 0-32-14.3-32-32v-8.2c-4.8-1.7-9.5-3.7-14.1-5.8l-5.8 5.8c-12.5 12.5-32.8 12.5-45.3 0L40.2 449.1c-12.5-12.5-12.5-32.8 0-45.3l5.8-5.8c-2.2-4.6-4.1-9.3-5.8-14.1H32c-17.7 0-32-14.3-32-32V320c0-17.7 14.3-32 32-32h8.2c1.7-4.8 3.7-9.5 5.8-14.1l-5.8-5.8c-12.5-12.5-12.5-32.8 0-45.3l22.6-22.6c12.5-12.5 32.8-12.5 45.3 0l5.8 5.8c4.6-2.2 9.3-4.1 14.1-5.8V192c0-17.7 14.3-32 32-32h50.7L266.3 64H160V96c0 17.7-14.3 32-32 32s-32-14.3-32-32V64zM160 320a96 96 0 1 1 0 192 96 96 0 1 1 0-192zm368 96a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/>
        </svg>
        <h1 class="text-3xl font-bold text-teal-400">Máquinas</h1>
      </div>
      
      <div class="mb-6 flex justify-end">
        <a
          href="/machines/new"
          class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg border-2 border-teal-400 inline-flex items-center gap-2 shadow-lg hover:shadow-xl transition duration-200"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Adicionar Máquina
        </a>
      </div>

      <% if (machines.length === 0) { %>
      <p class="text-gray-400">Nenhuma máquina cadastrada.</p>
      <% } else { %>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-gray-700 border border-gray-600">
          <thead>
            <tr class="bg-gray-600">
              <th class="py-2 px-4 border-b border-gray-500 text-left">Nome</th>
              <th class="py-2 px-4 border-b border-gray-500 text-left">Tipo</th>
              <th class="py-2 px-4 border-b border-gray-500 text-left">Valor/Hora</th>
              <th class="py-2 px-4 border-b border-gray-500 text-left">Placa</th>
              <th class="py-2 px-4 border-b border-gray-500 text-left">Ações</th>
            </tr>
          </thead>
          <tbody>
            <% machines.forEach(machine => { %>
            <tr class="hover:bg-gray-600">
              <td class="py-2 px-4 border-b border-gray-600"><%= machine.name %></td>
              <td class="py-2 px-4 border-b border-gray-600"><%= machine.type %></td>
              <td class="py-2 px-4 border-b border-gray-600 text-green-400">
                R$ <%= parseFloat(machine.hourlyRate).toFixed(2).replace('.', ',') %>
              </td>
              <td class="py-2 px-4 border-b border-gray-600"><%= machine.plate || '-' %></td>
              <td class="py-2 px-4 border-b border-gray-600">
                <div class="flex gap-2">
                  <a
                    href="/machines/edit/<%= machine.id %>"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg border-2 border-blue-500 inline-flex items-center gap-1 shadow-md hover:shadow-lg transition duration-200"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Editar
                  </a>
                  <form id="delete-form-<%= machine.id %>" action="/machines/delete/<%= machine.id %>" method="POST" class="inline-block">
                    <button
                      type="button"
                      class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg border-2 border-red-500 inline-flex items-center gap-1 shadow-md hover:shadow-lg transition duration-200"
                      onclick="handleDelete(<%= machine.id %>, 'máquina')"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                      Deletar
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <% } %>

      <div class="mt-8">
        <a
          href="/dashboard"
          class="block text-center bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg border-2 border-gray-600 w-full shadow-md hover:shadow-lg transition duration-200"
        >
          Voltar ao Painel
        </a>
      </div>
    </div>

    <script>
      // Verifica se o usuário ainda está autenticado
      (function() {
        // Desabilita o botão voltar após logout - verifica se página veio do cache
        window.addEventListener('pageshow', function(event) {
          if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
            // Página foi restaurada do cache - verifica autenticação
            fetch('/api/check-auth', {
              method: 'GET',
              credentials: 'include'
            })
            .then(response => {
              if (!response.ok) {
                window.location.replace('/login');
              }
            })
            .catch(() => {
              window.location.replace('/login');
            });
          }
        });
      })();

      // Função para lidar com exclusão
      async function handleDelete(id, type) {
        const confirmed = await customConfirm(`Tem certeza que deseja deletar esta ${type}?`);
        if (confirmed) {
          document.getElementById(`delete-form-${id}`).submit();
        }
      }
    </script>
  </body>
</html>
